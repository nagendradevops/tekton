---
# tasks file for ocs_for_prometheus
# - name: Login to the Openshift cli
#   shell: oc login --token={{ ocp_login_token }} --server={{ ocp_api_url }}

- name: List pods of openshift-monitoring
  shell: oc get pods,pvc -n {{ NAMESPACE }}
  register: pods_monitoring

- debug:
    msg: "{{ pods_monitoring }}"

- name: create temp directory for doing work in
  command: mktemp -d /tmp/pipeline-XXXXXX
  register: mktemp
  changed_when: False

- set_fact:
    tempdir: "{{ mktemp.stdout }}"

- name: copy template of pipeline
  template:
    src: maven-pipeline.yaml.j2
    dest: "{{ tempdir }}/maven-pipeline.yml"

- name: deploy pipeline
  shell: oc apply -f {{ tempdir }}/maven-pipeline.yml

- name: copy template of pipelinerun
  template:
    src: pipeline-run.yaml.j2
    dest: "{{ tempdir }}/pipeline-run.yml"

- name: deploy pipelinerun to trigger the pipeline
  shell: oc apply -f {{ tempdir }}/pipeline-run.yml


# - name: wait for 1 mins pods will be restarted
#   wait_for:
#      timeout: 60

- name: check pod status
  shell: oc get tasks,pipeline -n {{ NAMESPACE }}
  register: pods_monitoring

- debug:
    msg: "{{ pods_monitoring }}"
